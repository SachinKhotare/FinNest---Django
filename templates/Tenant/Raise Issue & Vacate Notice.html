{% extends "Tenant/base.html" %}
{% block title %}Dashboard - My Site{% endblock %}

{% block content %}

  <!-- Row for Cards -->
  <div class="row g-4 mb-4">
    <!-- Raise Issue Card -->
    <div class="col-md-6">
      <div class="card text-center border-0 shadow-lg h-100">
        <div class="card-body">
          <div class="mb-3">
            <i class="bi bi-exclamation-circle-fill text-danger" style="font-size: 2.5rem;"></i>
          </div>
          <h5 class="card-title fw-bold">Raise Issue</h5>
          <p class="text-muted">Submit a maintenance or service request instantly.</p>
          <button class="btn btn-danger px-4 py-2" data-bs-toggle="modal" data-bs-target="#issueModal">
            <i class="bi bi-pencil-square me-1"></i> Raise Ticket
          </button>
        </div>
      </div>
    </div>

    <!-- Submit Vacate Notice Card -->
    <div class="col-md-6">
      <div class="card text-center border-0 shadow-lg h-100">
        <div class="card-body">
          <div class="mb-3">
            <i class="bi bi-door-open-fill text-primary" style="font-size: 2.5rem;"></i>
          </div>
          <h5 class="card-title fw-bold">Submit Vacate Notice</h5>
          <p class="text-muted">Let us know your planned move-out date.</p>
          <button class="btn btn-primary px-4 py-2" data-bs-toggle="modal" data-bs-target="#vacateModal">
            <i class="bi bi-send-check-fill me-1"></i> Submit Notice
          </button>
        </div>
      </div>
    </div>
  </div>

 <!-- Tickets Table -->
<div class="card shadow border-0 mb-4">
  <div class="card-body">
    <h5 class="mb-3">Previous Tickets</h5>
    <input type="text" id="searchTickets" class="form-control mb-3" placeholder="Search tickets...">

    <!-- Scrollable Table (4 rows only) -->
    <div class="table-responsive" style="max-height: 280px; overflow-y: auto;">
      <table class="table table-bordered table-hover align-middle mb-0">
        <thead class="table-light">
          <tr>
            <th>ID</th>
            <th>Title</th>
            <th>Category</th>
            <th>Urgency</th>
            <th>Status</th>
            <th>Resolution Date</th>
          </tr>
        </thead>
        <tbody id="ticketTable">
          {% for issue in issues %}
            <tr>
              <td>#{{ issue.id }}</td>
              <td>{{ issue.title }}</td>
              <td>{{ issue.category }}</td>
              <td>
                {% if issue.urgency == "Low" %}
                  <span class="badge bg-secondary">{{ issue.urgency }}</span>
                {% elif issue.urgency == "Medium" %}
                  <span class="badge bg-info text-dark">{{ issue.urgency }}</span>
                {% elif issue.urgency == "High" %}
                  <span class="badge bg-warning text-dark">{{ issue.urgency }}</span>
                {% elif issue.urgency == "Critical" %}
                  <span class="badge bg-danger">{{ issue.urgency }}</span>
                {% endif %}
              </td>
              <td>
                {% if issue.status %}
                  <span class="badge bg-success">{{ issue.status }}</span>
                {% else %}
                  <span class="badge bg-primary">Open</span>
                {% endif %}
              </td>
              <td>{{ issue.estimated_resolution_date|default:"-" }}</td>
            </tr>
          {% empty %}
            <tr>
              <td colspan="6" class="text-center">No tickets found.</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Vacate Notice Modal -->
<div class="modal fade" id="vacateModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title"><i class="bi bi-door-open-fill me-2"></i> Vacate Notice Form</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form method="post">
          {% csrf_token %}
          <input type="text" class="form-control mb-3" name="name" placeholder="Full Name" required>
          <input type="text" class="form-control mb-3" name="flat_no" placeholder="Flat/Room No." required>
          <input type="date" class="form-control mb-3" name="date" required>
          <textarea class="form-control mb-3" rows="3" name="reason" placeholder="Reason (Optional)"></textarea>
          <button type="submit" class="btn btn-primary w-100">Submit Notice</button>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Raise Ticket Modal -->
<div class="modal fade" id="issueModal" tabindex="-1" aria-labelledby="issueModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="issueModalLabel"><i class="bi bi-exclamation-circle-fill me-2"></i> Raise Maintenance Ticket</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="ticketForm" method="post" action="{% url 'raise-issue' %}" enctype="multipart/form-data">
    {% csrf_token %}

          <div class="mb-3">
            <label class="form-label">Issue Title</label>
            <input type="text" class="form-control" name="title" placeholder="Short description of the issue" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Category</label>
            <select class="form-select" name="category" required>
              <option value="">Select Category</option>
              <option>Plumbing</option>
              <option>Electrical</option>
              <option>Internet</option>
              <option>Housekeeping</option>
              <option>Other</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">Urgency</label>
            <select id="urgencySelect" name="urgency" class="form-select" required>
              <option value="">Select Urgency</option>
              <option value="Low">Low</option>
              <option value="Medium">Medium</option>
              <option value="High">High</option>
              <option value="Critical">Critical</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">Estimated Resolution Date</label>
            <input type="date" id="resolutionDate" name="estimated_resolution_date" class="form-control" readonly>
          </div>
          <div class="mb-3">
            <label class="form-label">Details</label>
            <textarea class="form-control" rows="4" name="details" placeholder="Describe the issue in detail"></textarea>
          </div>
          <div class="mb-3">
            <label class="form-label">Attach Image (optional)</label>
            <input type="file" class="form-control" name="image" id="imgUpload">
            <img id="imgPreview" class="preview-img d-none" alt="Preview">
          </div>
          <button type="submit" class="btn btn-danger w-100"><i class="bi bi-send-fill me-1"></i> Submit Ticket</button>
        </form>
      </div>
    </div>
  </div>

<!-- Toast Notification -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
  <div id="successToast" class="toast align-items-center text-bg-success border-0" role="alert">
    <div class="d-flex">
      <div class="toast-body">
        âœ… Ticket submitted successfully!
      </div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
  // Auto-calculate resolution date
  document.getElementById("urgencySelect").addEventListener("change", function() {
    const urgency = this.value;
    const today = new Date();
    let daysToAdd = 5;
    if (urgency === "Low") daysToAdd = 7;
    else if (urgency === "Medium") daysToAdd = 5;
    else if (urgency === "High") daysToAdd = 3;
    else if (urgency === "Critical") daysToAdd = 1;
    today.setDate(today.getDate() + daysToAdd);
    document.getElementById("resolutionDate").value = today.toISOString().split("T")[0];
  });

  // Image Preview
  document.getElementById("imgUpload").addEventListener("change", function(e) {
    const file = e.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = function(event) {
        const imgPreview = document.getElementById("imgPreview");
        imgPreview.src = event.target.result;
        imgPreview.classList.remove("d-none");
      };
      reader.readAsDataURL(file);
    }
  });

  // Search Tickets
  document.getElementById("searchTickets").addEventListener("keyup", function() {
    const searchValue = this.value.toLowerCase();
    document.querySelectorAll("#ticketTable tr").forEach(row => {
      row.style.display = row.textContent.toLowerCase().includes(searchValue) ? "" : "none";
    });
  });

  // Function to show the toast
  function showSuccessToast() {
    var toastEl = document.getElementById("successToast");
    var toast = new bootstrap.Toast(toastEl);
    toast.show();
  }

  // Example: Show toast on page load
  document.addEventListener("DOMContentLoaded", function () {
    showSuccessToast();
  });
</script>

{% endblock %}