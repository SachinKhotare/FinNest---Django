{% extends "Tenant/base.html" %}
{% block title %}Rent Payment - My Site{% endblock %}

{% block content %}
<div class="payment-card container">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h4 class="mb-0">üè† Rent Payment</h4>
    <span id="paymentStatus" class="badge bg-warning status-badge">Pending</span>
  </div>

  <!-- Tenant Info -->
  <div class="mb-3">
    <p><strong>Tenant:</strong> {{ tenant.username }}</p>
    <p><strong>Flat:</strong> {{ tenant.address }}</p>
  </div>

  <form id="rentForm" method="get" action="{% url 'payment_success' %}">
    <div class="row">
      <!-- Left Column: Rent Details -->
      <div class="col-md-6 border-end">
        <h6 class="section-title"><i class="fa-solid fa-receipt me-2"></i>Rent Details</h6>
        <div class="mb-3">
          <label class="form-label">Rent Amount (‚Çπ)</label>
          <input type="number" class="form-control" value="{{ amount }}" readonly>
        </div>
        <div class="mb-3">
          <label class="form-label">Month</label>
          <select id="rentMonth" name="month" class="form-select" required>
            <option value="">Select Month</option>
            {% for m in months %}
              <option value="{{ m }}" {% if m == current_month %}selected{% endif %}>{{ m }}</option>
            {% endfor %}
          </select>
          <!-- Hidden input to pass month to success handler -->
          <input type="hidden" id="selectedMonth" name="month" value="{{ current_month }}">
        </div>
      </div>

      <!-- Right Column: Payment -->
      <div class="col-md-6">
        <h6 class="section-title"><i class="fa-solid fa-wallet me-2"></i>Payment Method</h6>
        <p>Pay securely using Razorpay.</p>

        <h6 class="section-title mt-4"><i class="fa-solid fa-envelope-open-text me-2"></i>Receipt</h6>
        
        <div class="form-check mb-3">
          <input class="form-check-input" name="emailReceipt" type="checkbox" id="emailReceipt" checked>
          <label class="form-check-label" for="emailReceipt">Email me a receipt</label>
        </div>
      </div>
    </div>

    <!-- Buttons -->
    <div class="d-flex gap-2 mt-4">
      <button type="submit" class="btn btn-success flex-fill">
        <i class="fa-solid fa-paper-plane me-1"></i> Pay Now
      </button>
    </div>
  </form>

  <!-- Payment History Button -->
  <div class="text-center mt-4">
    <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#historyModal">
      <i class="fa-solid fa-clock-rotate-left me-1"></i> View Payment History
    </button>
  </div>
</div>

<!-- Payment History Modal -->
<div class="modal fade" id="historyModal" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-light">
        <h5 class="modal-title"><i class="fa-solid fa-clock-rotate-left me-2"></i>Payment History</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <table class="table table-striped">
          <thead>
            <tr>
              <th>Date</th>
              <th>Month</th>
              <th>Amount (‚Çπ)</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody>
            {% for txn in tenant.payment_set.all %}
              <tr>
                <td>{{ txn.created_at|date:"d-m-Y" }}</td>
                <td>{{ txn.month }}</td>
                <td>{{ txn.amount }}</td>
                <td>{{ txn.status }}</td>
              </tr>
            {% empty %}
              <tr><td colspan="4" class="text-center">No payments yet.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Payment Success Modal -->
<div class="modal fade" id="paymentSuccessModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content shadow-lg border-0 rounded-3">
      <div class="modal-body text-center p-5">
        <h2 class="text-success mb-3">‚úÖ Payment Successful</h2>
        <p>Thank you, <strong>{{ tenant.username }}</strong>!</p>
        <p>Your rent payment of <strong>‚Çπ{{ tenant.monthly_rent }}</strong> has been received.</p>
        
        <p id="paymentIdBox" class="small text-muted"></p>
        
        <a href="{% url 'dashboard_view' %}" class="btn btn-primary mt-3">
          Back to Dashboard
        </a>
      </div>
    </div>
  </div>
</div>

<!-- Razorpay Checkout -->
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script>
document.getElementById("rentForm").addEventListener("submit", function(e){
  e.preventDefault();

  // Set hidden input value to currently selected month
  document.getElementById("selectedMonth").value = document.getElementById("rentMonth").value;

  var options = {
    "key": "{{ razorpay_id }}",
    "amount": "{{ payment.amount }}",   // in paisa
    "currency": "{{ payment.currency }}",
    "name": "Rent Payment",
    "description": "Rent for {{ tenant.username }}",
    "order_id": "{{ payment.id }}",   // generated by backend
    "handler": function (response){
        // Get checkbox value
        let emailReceipt = document.getElementById("emailReceipt").checked ? "on" : "off";

        // Insert Payment ID into modal dynamically
        document.getElementById("paymentIdBox").innerHTML = "<b>Payment ID:</b> " + response.razorpay_payment_id;

        // Show success modal
        var successModal = new bootstrap.Modal(document.getElementById("paymentSuccessModal"));
        successModal.show();

        // Redirect to Django success view after 3 seconds
        setTimeout(function(){
            window.location.href = "{% url 'payment_success' %}?payment_id=" 
                                   + response.razorpay_payment_id 
                                   + "&order_id=" + response.razorpay_order_id 
                                   + "&signature=" + response.razorpay_signature
                                   + "&month=" + document.getElementById("selectedMonth").value
                                   + "&emailReceipt=" + emailReceipt;
        }, 3000);
    },
    "prefill": {
        "name": "{{ tenant.username }}",
        "email": "{{ request.user.email }}",
        "contact": "{{ tenant.phone|default:'9999999999' }}"
    },
    "theme": {
        "color": "#3399cc"
    }
  };

  var rzp1 = new Razorpay(options);
  rzp1.open();
});
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
{% endblock %}
