{% extends "base.html" %}
{% block title %}Dashboard - FinNest{% endblock %}

{% block content %}

<!-- 🔔 Alert Popup 
<div id="pageAlert" class="popup-overlay d-flex align-items-center justify-content-center" style="display:none;">
  <div class="popup-box shadow-lg text-center">
    <h4 class="fw-bold text-primary">🔔 Welcome to FinNest!</h4>
    <p class="text-muted">Stay informed with your latest alerts and suggestions.</p>
    <button class="btn-modern mt-3" onclick="dismissPopup()">Dismiss</button>
  </div>
</div> -->

<!-- Tenant Management -->
<div class="d-flex justify-content-between align-items-center mb-3">
  <h4 class="fw-semibold text-gradient">👥 Tenant Management</h4>
  <div>
    <button class="btn btn-success shadow-sm" data-bs-toggle="modal" data-bs-target="#addTenantModal">➕ Add Tenant</button>
    <button class="btn btn-danger shadow-sm" data-bs-toggle="modal" data-bs-target="#deleteTenantModal">🗑 Delete Tenant</button>
  </div>
</div>

<!-- Add Tenant Modal -->
<div class="modal fade" id="addTenantModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content glass-card">
      <div class="modal-header border-0">
        <h5 class="modal-title fw-bold">Add Tenant</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="tenantForm" method="POST" enctype="multipart/form-data" action="{% url 'owner-rental' %}">
          {% csrf_token %}
          <input type="hidden" name="add_tenant" value="1">

          <div class="row g-3">
            <!-- Tenant Name & Rent -->
            <div class="col-md-6">
              <label class="form-label">Tenant Name</label>
              <input type="text" class="form-control" name="name" required>
            </div>
            <div class="col-md-6">
              <label class="form-label">Monthly Rent</label>
              <input type="number" class="form-control" name="monthly_rent" required>
            </div>

            <!-- Dates -->
            <div class="col-md-6">
              <label class="form-label">Agreement Start Date</label>
              <input type="date" class="form-control" name="start_date" required>
            </div>
            <div class="col-md-6">
              <label class="form-label">Agreement End Date</label>
              <input type="date" class="form-control" name="end_date" required>
            </div>

            <!-- Address -->
            <div class="col-md-12">
              <label class="form-label">Address</label>
              <textarea class="form-control" rows="2" name="address" required></textarea>
            </div>

            <!-- Contact & Password -->
            <div class="col-md-6">
              <label class="form-label">Contact Number</label>
              <input type="text" class="form-control" name="contact_number" placeholder="+91-" required>
            </div>
            <div class="col-md-6">
              <label class="form-label">Password</label>
              <input type="password" class="form-control" name="password" required>
            </div>

            <!-- Aadhaar & Deposit -->
            <div class="col-md-6">
              <label class="form-label">Aadhar Card Number</label>
              <input type="text" class="form-control" name="aadhar_number" placeholder="XXXX-XXXX-XXXX" required>
            </div>
            <div class="col-md-6">
              <label class="form-label">Security Deposit (₹)</label>
              <input type="number" class="form-control" name="security_deposit">
            </div>

            <!-- Files -->
            <div class="col-md-6">
              <label class="form-label">Upload Aadhaar Card</label>
              <input type="file" class="form-control" name="aadhar_photo" accept="image/*">
            </div>
            <div class="col-md-6">
              <label class="form-label">Upload Agreement</label>
              <input type="file" class="form-control" name="agreement_file" accept=".pdf,.jpg,.png">
            </div>
          </div>

          <div class="modal-footer border-0">
            <button type="submit" class="btn-modern">Save</button>
            <button type="button" class="btn btn-secondary rounded-pill" data-bs-dismiss="modal">Cancel</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Delete Tenant Modal -->
<div class="modal fade" id="deleteTenantModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content glass-card">
      <div class="modal-header border-0">
        <h5 class="modal-title">Delete Tenant</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <form method="post" action="{% url 'owner-rental' %}">
        {% csrf_token %}
        <input type="hidden" name="delete_tenant" value="1">
        <div class="modal-body">
          <label>Select Tenant</label>
          <select class="form-select" name="tenant_id" required>
            {% for tenant in tenants %}
              <option value="{{ tenant.id }}">{{ tenant.name }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="modal-footer border-0">
          <button type="submit" class="btn btn-danger rounded-pill">Delete</button>
          <button type="button" class="btn btn-secondary rounded-pill" data-bs-dismiss="modal">Cancel</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Tenant Selector -->
<div class="mb-3">
  <label class="form-label">Tenant Name</label>
  <select id="tenantName" class="form-select" required>
    <option value="" disabled selected>-- Select Tenant --</option>
    {% for tenant in tenants %}
      <option value="{{ tenant.id }}">{{ tenant.name }}</option>
    {% endfor %}
  </select>
</div>

<!-- Agreement -->
<div id="agreementSection" class="card glass-card mt-4" style="display:none;">
  <div class="card-header bg-gradient text-black fw-bold" style="background: linear-gradient(135deg,#6366f1,#14b8a6);">
    📑 Agreement Details
  </div>
  <div class="card-body">
    <p id="agreementDetails"></p>
    <button class="btn btn-success btn-sm" id="agreementCopyBtn">📄 Agreement Copy</button>
    <button class="btn btn-warning btn-sm" data-bs-toggle="modal" data-bs-target="#aadharModal" id="viewAadharBtn">🆔 View Aadhaar</button>
  </div>
</div>

<!-- Aadhaar Modal -->
<div class="modal fade" id="aadharModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content glass-card text-center">
      <div class="modal-header border-0">
        <h5 class="modal-title">Aadhaar Card</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <img id="aadharImage" src="" class="img-fluid rounded shadow" alt="Aadhar Card">
      </div>
    </div>
  </div>
</div>

<!-- Rent Schedule -->
<div id="rentTablediv" class="card shadow-sm mt-4" style="display:none;">
  <div class="card-header bg-gradient text-black fw-bold" style="background: linear-gradient(135deg,#6366f1,#14b8a6);">
    🏠 Monthly Rent Tracker
  </div>
  <div class="card-body p-0">
    <table class="table table-hover align-middle mb-0" id="rentTable">
      <thead class="table-light">
        <tr>
          <th>Month</th>
          <th>Rent Amount</th>
          <th>Status</th>
          <th>Comment</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<div id="issuesSection" class="card glass-card mt-4" style="display:none;">
  <div class="card-header bg-danger text-white fw-bold">⚠️ Tenant Issues</div>
  <div class="card-body p-0">
    <table class="table table-striped align-middle mb-0">
      <thead class="table-light">
        <tr>
          <th>ID</th>
          <th>Title</th>
          <th>Category</th>
          <th>Urgency</th>
          <th>Details</th>
          <th>Status</th>
          <th>Owner Status</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody id="issuesTableBody"></tbody>
    </table>
  </div>
</div>

<!-- Vacate Notices -->
<div id="vacateSection" class="card glass-card mt-4" style="display:none;">
  <div class="card-header bg-warning text-dark fw-bold">🚪 Vacate Notices</div>
  <div class="card-body p-0">
    <table class="table table-striped align-middle mb-0">
      <thead class="table-light">
        <tr>
          <th>ID</th><th>Reason</th><th>Vacate Date</th><th>Name</th><th>Status</th><th>Action</th>
        </tr>
      </thead>
      <tbody id="vacateTableBody"></tbody>
    </table>
  </div>
</div>


<!-- ===== Scripts (updated into OLD structure) ===== -->
<script>
document.addEventListener("DOMContentLoaded", function () {
  const startDateInput = document.querySelector("input[name='start_date']");
  const endDateInput = document.querySelector("input[name='end_date']");

  if (startDateInput && endDateInput) {
    startDateInput.addEventListener("change", function () {
      if (this.value) {
        let startDate = new Date(this.value);

        // Add 11 months to start date
        let endDate = new Date(startDate);
        endDate.setMonth(endDate.getMonth() + 11);

        // Fix overflow bug
        if (endDate.getDate() !== startDate.getDate()) {
          endDate.setDate(0); 
        }

        let year = endDate.getFullYear();
        let month = String(endDate.getMonth() + 1).padStart(2, "0");
        let day = String(endDate.getDate()).padStart(2, "0");
        endDateInput.value = `${year}-${month}-${day}`;
      }
    });
  }

  // === Tenant Change (Load Agreements, Rents, Issues, Vacate Notices) ===
  document.getElementById("tenantName").addEventListener("change", function() {
    let tenantId = this.value;
    if (tenantId) {
      fetch(`/api/agreement/${tenantId}/`)
        .then(response => response.json())
        .then(data => {
          // Agreement details
          document.getElementById("agreementDetails").innerHTML =
            `<strong>Rent:</strong> ₹${data.rent} | 
             <strong>Period:</strong> ${data.start_date} to ${data.end_date} | 
             <strong>Contact:</strong> ${data.contact} | 
             <strong>Address:</strong> ${data.address}`;

          document.getElementById("agreementCopyBtn").onclick = () => {
            if (data.agreement_file) window.open(data.agreement_file,"_blank");
            else alert("No agreement file found!");
          };
          document.getElementById("aadharImage").src = data.aadhar_photo || "";

          // Rent table
let tbody = document.querySelector("#rentTable tbody");
tbody.innerHTML = "";

const months = [
  "January","February","March","April","May","June","July","August",
  "September","October","November","December"
];

let rentMap = {};
if (data.rent_records) {
  data.rent_records.forEach(r => rentMap[r.month] = r);
}

let startDate = new Date(data.start_date);
let startMonth = startDate.getMonth(), startYear = startDate.getFullYear();

for (let i = 0; i < 11; i++) {
  let mi = (startMonth + i) % 12;
  let year = startYear + Math.floor((startMonth + i) / 12);
  let monthYear = `${months[mi]} ${year}`;

  let record = rentMap[monthYear];
  let status = record ? record.status : "Not Paid";
  let amount = record ? record.amount : data.rent;

  // ✅ Auto-fill comment if paid
  let comment = "";
  if (record) {
    if (status === "SUCCESS" || status === "Paid") {
      
      comment = `Received Rent`;
    } else {
      comment = record.comment || "";
    }
  }

  tbody.innerHTML += `
    <tr>
      <td>${monthYear}</td>
      <td>₹${amount}</td>
      <td>
      <select class="form-select form-select-sm" ${status==="SUCCESS" || status==="Paid" ? "disabled" : ""}>
  <option value="Not Paid" ${status==="Not Paid"?"selected":""}>Not Paid</option>
  <option value="Paid" ${status==="SUCCESS" || status==="Paid" ?"selected":""}>Paid</option>
</select>

      </td>
      <td><input type="text" class="form-control form-control-sm" value="${comment}" ${status==="SUCCESS" || status==="Paid" ? "readonly" : ""}>
</td>
    </tr>`;
}

document.getElementById("rentTablediv").style.display = "block";


          // === Issues Table ===
          let issuesBody = document.getElementById("issuesTableBody");
          issuesBody.innerHTML = "";
          if (data.issues?.length > 0) {
            data.issues.forEach(issue => {
              issuesBody.innerHTML += `
                <tr>
                  <td>${issue.id}</td>
                  <td>${issue.title}</td>
                  <td>${issue.category || ""}</td>
                  <td><span class="badge ${issue.urgency === "High" ? "bg-danger" : issue.urgency === "Medium" ? "bg-warning text-dark" : "bg-success"}">${issue.urgency}</span></td>
                  <td>${issue.details || ""}</td>
                  <td><span class="badge ${issue.status === "Resolved" ? "bg-success" : issue.status === "In Progress" ? "bg-primary" : "bg-secondary"}">${issue.status}</span></td>
                  <td>${issue.owner_status || "Pending"}</td>
                  <td>
                    ${issue.status !== "Resolved" ? 
                      `<button class="btn btn-sm btn-success" onclick="resolveIssue(${issue.id})">Resolve</button>` 
                      : `<span class="text-muted">✔ Done</span>`}
                  </td>
                </tr>`;
            });
            document.getElementById("issuesSection").style.display = "block";
          } else {
            document.getElementById("issuesSection").style.display = "none";
          }

          // === Vacate Notices (Fixed logic for Approve/Reject) ===
          let vacateBody=document.getElementById("vacateTableBody");
          vacateBody.innerHTML="";
          if (data.vacate_notices?.length>0){
            data.vacate_notices.forEach(notice=>{
              vacateBody.innerHTML+=`
                <tr>
                  <td>${notice.id}</td>
                  <td>${notice.reason}</td>
                  <td>${notice.date}</td>
                  <td>${notice.name || ""}</td>
                  <td id="status-${notice.id}">
                    ${notice.status || "Pending"}
                    ${notice.status === "Rejected" && notice.rejection_reason ? `<br><small class="text-danger">Reason: ${notice.rejection_reason}</small>` : ""}
                  </td>
                  <td>
                    ${
                      notice.status === "Approved"
                        ? `<span class="badge bg-success">✅ Approved by Owner</span>`
                        : notice.status === "Rejected"
                          ? `<span class="badge bg-danger">❌ Rejected</span>`
                          : `
                            <button class="btn btn-sm btn-success" onclick="updateVacateStatus(${notice.id}, 'Approved')">Approve</button>
                            <button class="btn btn-sm btn-danger" onclick="openRejectModal(${notice.id})">Reject</button>
                          `
                    }
                  </td>
                </tr>`;
            });
            document.getElementById("vacateSection").style.display="block";
          } else {
            document.getElementById("vacateSection").style.display="none";
          }

          document.getElementById("agreementSection").style.display="block";
        })
        .catch(err=>{
          console.error("Error:",err);
          alert("Unable to load tenant details.");
        });
    }
  });
}); // END DOMContentLoaded

// === Function: Approve/Reject Vacate ===
function updateVacateStatus(id, status, reason="") {
  fetch(`/update-vacate-status/${id}/`, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "X-CSRFToken": getCookie("csrftoken"),
    },
    body: JSON.stringify({ status, reason })
  })
  .then(res => res.json())
  .then(res => {
    if(res.success){
      let statusCell = document.getElementById(`status-${id}`);
      if (status === "Approved") {
        statusCell.innerHTML = `<span class="badge bg-success">✅ Approved by Owner</span>`;
      } else if (status === "Rejected" && reason) {
        statusCell.innerHTML = `❌ Rejected<br><small class="text-danger">Reason: ${reason}</small>`;
      }
    } else {
      alert("Error: " + res.message);
    }
  });
}

// === Bootstrap Modal Rejection ===
function openRejectModal(id) {
  document.getElementById("rejectNoticeId").value = id;
  document.getElementById("rejectReason").value = "";
  let modal = new bootstrap.Modal(document.getElementById("rejectModal"));
  modal.show();
}

function submitRejection() {
  let id = document.getElementById("rejectNoticeId").value;
  let reason = document.getElementById("rejectReason").value.trim();
  if (!reason) {
    alert("Please enter a reason for rejection.");
    return;
  }
  updateVacateStatus(id, "Rejected", reason);
  bootstrap.Modal.getInstance(document.getElementById("rejectModal")).hide();
}

// === Resolve Issue ===
function resolveIssue(issueId) {
  fetch(`/issues/${issueId}/resolve/`, {
    method: "POST",
    headers: { "X-CSRFToken": getCookie("csrftoken") }
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) {
      alert(data.message);
      location.reload();
    } else {
      alert("Error: " + data.message);
    }
  });
}

// === CSRF Helper ===
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    let cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      let cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}

function dismissPopup(){ document.getElementById("pageAlert").style.display="none"; }
window.addEventListener("load",()=>{ document.getElementById("pageAlert").style.display="flex"; });
</script>

<!-- Reject Modal -->
<div class="modal fade" id="rejectModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title">Reject Vacate Notice</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="rejectNoticeId">
        <div class="mb-3">
          <label for="rejectReason" class="form-label">Reason for Rejection</label>
          <textarea id="rejectReason" class="form-control" rows="3" placeholder="Enter reason"></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button class="btn btn-danger" onclick="submitRejection()">Reject</button>
      </div>
    </div>
  </div>
</div>

{% endblock %}
