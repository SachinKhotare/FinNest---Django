{% extends "base.html" %}
{% block title %}Dashboard - FinNest{% endblock %}

{% block content %}

<!-- 🔔 Alert Popup 
<div id="pageAlert" class="popup-overlay d-flex align-items-center justify-content-center" style="display:none;">
  <div class="popup-box shadow-lg text-center">
    <h4 class="fw-bold text-primary">🔔 Welcome to FinNest!</h4>
    <p class="text-muted">Stay informed with your latest alerts and suggestions.</p>
    <button class="btn-modern mt-3" onclick="dismissPopup()">Dismiss</button>
  </div>
</div> -->

<!-- Tenant Management -->
<div class="d-flex justify-content-between align-items-center mb-3">
  <h4 class="fw-semibold text-gradient">👥 Tenant Management</h4>
  <div>
    <button class="btn-modern me-2" data-bs-toggle="modal" data-bs-target="#addTenantModal">➕ Add Tenant</button>
    <button class="btn btn-danger rounded-pill shadow-sm" data-bs-toggle="modal" data-bs-target="#deleteTenantModal">🗑 Delete Tenant</button>
  </div>
</div>

<!-- Add Tenant Modal -->
<div class="modal fade" id="addTenantModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content glass-card">
      <div class="modal-header border-0">
        <h5 class="modal-title fw-bold">Add Tenant</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="tenantForm" method="POST" enctype="multipart/form-data" action="{% url 'owner-rental' %}">
          {% csrf_token %}
          <input type="hidden" name="add_tenant" value="1">

          <div class="row g-3">
            <!-- Tenant Name & Rent -->
            <div class="col-md-6">
              <label class="form-label">Tenant Name</label>
              <input type="text" class="form-control" name="name" required>
            </div>
            <div class="col-md-6">
              <label class="form-label">Monthly Rent</label>
              <input type="number" class="form-control" name="monthly_rent" required>
            </div>

            <!-- Dates -->
            <div class="col-md-6">
              <label class="form-label">Agreement Start Date</label>
              <input type="date" class="form-control" name="start_date" required>
            </div>
            <div class="col-md-6">
              <label class="form-label">Agreement End Date</label>
              <input type="date" class="form-control" name="end_date" required>
            </div>

            <!-- Address -->
            <div class="col-md-12">
              <label class="form-label">Address</label>
              <textarea class="form-control" rows="2" name="address" required></textarea>
            </div>

            <!-- Contact & Password -->
            <div class="col-md-6">
              <label class="form-label">Contact Number</label>
              <input type="text" class="form-control" name="contact_number" placeholder="+91-" required>
            </div>
            <div class="col-md-6">
              <label class="form-label">Password</label>
              <input type="password" class="form-control" name="password" required>
            </div>

            <!-- Aadhaar & Deposit -->
            <div class="col-md-6">
              <label class="form-label">Aadhar Card Number</label>
              <input type="text" class="form-control" name="aadhar_number" placeholder="XXXX-XXXX-XXXX" required>
            </div>
            <div class="col-md-6">
              <label class="form-label">Security Deposit (₹)</label>
              <input type="number" class="form-control" name="security_deposit">
            </div>

            <!-- Files -->
            <div class="col-md-6">
              <label class="form-label">Upload Aadhaar Card</label>
              <input type="file" class="form-control" name="aadhar_photo" accept="image/*">
            </div>
            <div class="col-md-6">
              <label class="form-label">Upload Agreement</label>
              <input type="file" class="form-control" name="agreement_file" accept=".pdf,.jpg,.png">
            </div>
          </div>

          <div class="modal-footer border-0">
            <button type="submit" class="btn-modern">Save</button>
            <button type="button" class="btn btn-secondary rounded-pill" data-bs-dismiss="modal">Cancel</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Delete Tenant Modal -->
<div class="modal fade" id="deleteTenantModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content glass-card">
      <div class="modal-header border-0">
        <h5 class="modal-title">Delete Tenant</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <form method="post" action="{% url 'owner-rental' %}">
        {% csrf_token %}
        <input type="hidden" name="delete_tenant" value="1">
        <div class="modal-body">
          <label>Select Tenant</label>
          <select class="form-select" name="tenant_id" required>
            {% for tenant in tenants %}
              <option value="{{ tenant.id }}">{{ tenant.name }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="modal-footer border-0">
          <button type="submit" class="btn btn-danger rounded-pill">Delete</button>
          <button type="button" class="btn btn-secondary rounded-pill" data-bs-dismiss="modal">Cancel</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Tenant Selector -->
<div class="mb-3">
  <label class="form-label">Tenant Name</label>
  <select id="tenantName" class="form-select" required>
    <option value="" disabled selected>-- Select Tenant --</option>
    {% for tenant in tenants %}
      <option value="{{ tenant.id }}">{{ tenant.name }}</option>
    {% endfor %}
  </select>
</div>

<!-- Agreement -->
<div id="agreementSection" class="card glass-card mt-4" style="display:none;">
  <div class="card-header bg-gradient text-white fw-bold" style="background: linear-gradient(135deg,#6366f1,#14b8a6);">
    📑 Agreement Details
  </div>
  <div class="card-body">
    <p id="agreementDetails"></p>
    <button class="btn-modern btn-sm me-2" id="agreementCopyBtn">📄 Agreement Copy</button>
    <button class="btn btn-warning btn-sm rounded-pill" data-bs-toggle="modal" data-bs-target="#aadharModal" id="viewAadharBtn">🆔 View Aadhaar</button>
  </div>
</div>

<!-- Aadhaar Modal -->
<div class="modal fade" id="aadharModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content glass-card text-center">
      <div class="modal-header border-0">
        <h5 class="modal-title">Aadhaar Card</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <img id="aadharImage" src="" class="img-fluid rounded shadow" alt="Aadhar Card">
      </div>
    </div>
  </div>
</div>

<!-- Rent Schedule -->
<div id="rentTablediv" class="card shadow-sm mt-4" style="display:none;">
  <div class="card-header bg-gradient text-white fw-bold" style="background: linear-gradient(135deg,#6366f1,#14b8a6);">
    🏠 Rent Payment Schedule (11 Months)
  </div>
  <div class="card-body p-0">
    <table class="table table-hover align-middle mb-0" id="rentTable">
      <thead class="table-light">
        <tr>
          <th>Month</th>
          <th>Rent Amount</th>
          <th>Status</th>
          <th>Comment</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<!-- Issues -->
<div id="issuesSection" class="card glass-card mt-4" style="display:none;">
  <div class="card-header bg-danger text-white fw-bold">⚠️ Tenant Issues</div>
  <div class="card-body p-0">
    <table class="table table-striped align-middle mb-0">
      <thead class="table-light">
        <tr>
          <th>ID</th><th>Title</th><th>Created At</th><th>Details</th><th>Status</th>
        </tr>
      </thead>
      <tbody id="issuesTableBody"></tbody>
    </table>
  </div>
</div>

<!-- Vacate Notices -->
<div id="vacateSection" class="card glass-card mt-4" style="display:none;">
  <div class="card-header bg-warning text-dark fw-bold">🚪 Vacate Notices</div>
  <div class="card-body p-0">
    <table class="table table-striped align-middle mb-0">
      <thead class="table-light">
        <tr>
          <th>ID</th><th>Reason</th><th>Vacate Date</th><th>Created At</th><th>Status</th>
        </tr>
      </thead>
      <tbody id="vacateTableBody"></tbody>
    </table>
  </div>
</div>

<!-- ===== Extra Styles ===== -->
<style>
/* ===== Base Styles ===== */
body {
  font-family: 'Poppins', sans-serif;
  background-color: #f9fafb;
  color: #333;
}

/* Headings with subtle professional gradient */
.text-gradient {
  background: linear-gradient(90deg, #3b82f6, #14b8a6);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  font-weight: 600;
}

/* Buttons */
.btn-modern {
  background: #3b82f6;
  color: #fff !important;
  border-radius: 8px;
  padding: 0.5rem 1.2rem;
  font-size: 0.9rem;
  font-weight: 500;
  transition: all 0.2s ease;
  border: none;
}
.btn-modern:hover {
  background: #2563eb;
  transform: translateY(-1px);
}
.btn-danger,
.btn-secondary {
  border-radius: 8px;
}

/* Cards */
.glass-card {
  background: #fff !important;
  border-radius: 10px;
  border: 1px solid #e5e7eb;
  box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}

/* Modal */
.modal-content {
  border-radius: 10px;
}

/* Table */
.table {
  font-size: 0.9rem;
}
.table thead {
  background-color: #f1f5f9;
  font-weight: 600;
}
.table-hover tbody tr:hover {
  background-color: #f9fafb;
}

/* Popup Overlay */
.popup-overlay {
  position: fixed; top:0; left:0; right:0; bottom:0;
  background: rgba(0,0,0,0.35);
  z-index: 1055;
}
.popup-box {
  background: #fff;
  border-radius: 10px;
  padding: 1.8rem;
  max-width: 380px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}
.popup-box h4 {
  font-weight: 600;
  color: #2563eb;
}
.popup-box p {
  color: #6b7280;
  font-size: 0.9rem;
}
</style>


<!-- ===== Scripts (same logic) ===== -->
<script>
document.getElementById("tenantName").addEventListener("change", function() {
  let tenantId = this.value;
  if (tenantId) {
    fetch(`/api/agreement/${tenantId}/`)
      .then(response => response.json())
      .then(data => {
        document.getElementById("agreementDetails").innerHTML =
          `<strong>Rent:</strong> ₹${data.rent} | 
           <strong>Period:</strong> ${data.start_date} to ${data.end_date} | 
           <strong>Contact:</strong> ${data.contact} | 
           <strong>Address:</strong> ${data.address}`;

        document.getElementById("agreementCopyBtn").onclick = () => {
          if (data.agreement_file) window.open(data.agreement_file,"_blank");
          else alert("No agreement file found!");
        };
        document.getElementById("aadharImage").src = data.aadhar_photo || "";

        // Rent table
        let tbody = document.querySelector("#rentTable tbody");
        tbody.innerHTML = "";
        const months = ["January","February","March","April","May","June","July","August","September","October","November","December"];
        let rentMap = {};
        if (data.rent_records) {
          data.rent_records.forEach(r => rentMap[r.month] = r);
        }
        let startDate = new Date(data.start_date);
        let startMonth = startDate.getMonth(), startYear = startDate.getFullYear();
        for (let i=0;i<11;i++) {
          let mi = (startMonth+i)%12;
          let year = startYear+Math.floor((startMonth+i)/12);
          let monthYear = `${months[mi]} ${year}`;
          let record = rentMap[monthYear];
          let status = record ? record.status : "Not Paid";
          let comment = record ? (record.comment||"") : "";
          let amount = record ? record.amount : data.rent;
          tbody.innerHTML += `
            <tr>
              <td>${monthYear}</td>
              <td>₹${amount}</td>
              <td>
                <select class="form-select form-select-sm">
                  <option value="Not Paid" ${status==="Not Paid"?"selected":""}>Not Paid</option>
                  <option value="Paid" ${status==="SUCCESS"?"selected":""}>Paid</option>
                </select>
              </td>
              <td><input type="text" class="form-control form-control-sm" value="${comment}"></td>
            </tr>`;
        }
        document.getElementById("rentTablediv").style.display="block";

        // Issues
        let issuesBody=document.getElementById("issuesTableBody");
        issuesBody.innerHTML="";
        if (data.issues?.length>0){
          data.issues.forEach(issue=>{
            issuesBody.innerHTML+=`
              <tr>
                <td>${issue.id}</td><td>${issue.title}</td>
                <td>${issue.created_at}</td><td>${issue.details||""}</td>
                <td>${issue.status||""}</td>
              </tr>`;
          });
          document.getElementById("issuesSection").style.display="block";
        } else document.getElementById("issuesSection").style.display="none";

        // Vacate Notices
        let vacateBody=document.getElementById("vacateTableBody");
        vacateBody.innerHTML="";
        if (data.vacate_notices?.length>0){
          data.vacate_notices.forEach(notice=>{
            vacateBody.innerHTML+=`
              <tr>
                <td>${notice.id}</td><td>${notice.reason}</td>
                <td>${notice.date}</td><td>${notice.created_at}</td>
                <td>${notice.status}</td>
              </tr>`;
          });
          document.getElementById("vacateSection").style.display="block";
        } else document.getElementById("vacateSection").style.display="none";

        document.getElementById("agreementSection").style.display="block";
      })
      .catch(err=>{
        console.error("Error:",err);
        alert("Unable to load tenant details.");
      });
  }
});
function dismissPopup(){ document.getElementById("pageAlert").style.display="none"; }
window.addEventListener("load",()=>{ document.getElementById("pageAlert").style.display="flex"; });
</script>

{% endblock %}
